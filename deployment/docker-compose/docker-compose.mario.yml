# Mario's Pizzeria Sample Application - Docker Compose Configuration
# This file should be used together with docker-compose.shared.yml
# Usage: docker-compose -f docker-compose.shared.yml -f docker-compose.mario.yml up

services:
  # üé® UI Builder (Parcel Watch Mode)
  # Automatically rebuilds UI assets on file changes
  ui-builder:
    image: node:20-alpine
    working_dir: /app/samples/mario-pizzeria/ui
    command: npm run dev
    volumes:
      - ../../:/app # Project root
      - /app/samples/mario-pizzeria/ui/node_modules # Anonymous volume for node_modules
    networks:
      - pyneuro-net
    environment:
      NODE_ENV: development
    # Ensure node_modules is installed first
    entrypoint: >
      sh -c "
      npm install &&
      npm run dev
      "

  # ÔøΩüçï Mario's Pizzeria Application
  # http://localhost:8080/
  # http://localhost:8080/docs
  # http://localhost:8080/api/docs
  mario-pizzeria-app:
    image: mario-pizzeria-app
    build:
      context: ../../ # Project root
      dockerfile: samples/mario-pizzeria/Dockerfile
    command:
      [
        "sh",
        "-c",
        "pip install debugpy -t /tmp && cd samples/mario-pizzeria && PYTHONPATH=/tmp:/app/src:/app/samples/mario-pizzeria python -m debugpy --listen 0.0.0.0:5678 -m uvicorn main:app --host 0.0.0.0 --port 8080 --reload --reload-dir /app/samples/mario-pizzeria --reload-dir /app/src",
      ]
    ports:
      - ${MARIO_PORT:-8080}:8080 # Main application port
      - ${MARIO_DEBUG_PORT:-5678}:5678 # Debug port
    environment:
      LOCAL_DEV: true
      LOG_LEVEL: INFO
      PYTHONPATH: "src"
      # Database connections
      CONNECTION_STRINGS: '{"mongo": "mongodb://root:neuroglia123@mongodb:27017/?authSource=admin", "eventstore": "esdb://eventstoredb:2113?Tls=false"}'
      # Event streaming
      CLOUD_EVENT_SINK: http://event-player:8080/events/pub
      CLOUD_EVENT_SOURCE: https://mario-pizzeria.io
      CLOUD_EVENT_TYPE_PREFIX: io.mario-pizzeria
      # Authentication
      KEYCLOAK_SERVER_URL: http://keycloak:8080
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-pyneuro}
      KEYCLOAK_CLIENT_ID: mario-app
      # Session store (Redis)
      REDIS_URL: redis://redis:6379/0
      REDIS_ENABLED: ${REDIS_ENABLED:-true}
      REDIS_KEY_PREFIX: "mario_session:"
      SESSION_TIMEOUT_HOURS: 24
      # Application settings
      DATA_DIR: /app/data
      ENABLE_CORS: "true"
      # OpenTelemetry configuration - Metrics & Traces only (no logging)
      OTEL_SERVICE_NAME: mario-pizzeria
      OTEL_SERVICE_VERSION: 1.0.0
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      # Performance optimizations - DISABLED resource-heavy features:
      # OTEL_LOGS_EXPORTER: none (no log export)
      # OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: false (no auto-logging)
      # OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_*: not set (no header capture)
    volumes:
      - ../../:/app # Project root
      - ../../data/:/app/data
    networks:
      - pyneuro-net
    depends_on:
      - mongodb
      - redis
      - keycloak
      - event-player
      - ui-builder # Ensure UI is built before app starts
