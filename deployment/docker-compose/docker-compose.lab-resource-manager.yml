# Lab Resource Manager Sample Application - Docker Compose Configuration
# This file should be used together with docker-compose.shared.yml
# Usage: docker-compose -f docker-compose.shared.yml -f docker-compose.lab-resource-manager.yml up

services:
  # ðŸ§ª Lab Resource Manager Application
  # http://localhost:8000/
  # http://localhost:8000/docs
  # http://localhost:8000/api/docs
  lab-resource-manager-app:
    image: lab-resource-manager-app
    build:
      context: ../../ # Project root
      dockerfile: samples/lab_resource_manager/Dockerfile
    command:
      [
        "sh",
        "-c",
        "pip install debugpy -t /tmp && cd samples/lab_resource_manager && PYTHONPATH=/tmp:/app/src:/app/samples/lab_resource_manager python -m debugpy --listen 0.0.0.0:5678 -m uvicorn main:app --host 0.0.0.0 --port 8080 --reload --reload-dir /app/samples/lab_resource_manager --reload-dir /app/src",
      ]
    ports:
      - ${LAB_MANAGER_PORT:-8003}:8080 # Main application port
      - ${LAB_MANAGER_DEBUG_PORT:-5679}:5678 # Debug port (different from mario)
    environment:
      LOCAL_DEV: true
      LOG_LEVEL: INFO
      PYTHONPATH: "src"
      # Database connections
      CONNECTION_STRINGS: '{"mongo": "mongodb://root:neuroglia123@mongodb:27017/?authSource=admin"}'
      # Event streaming
      CLOUD_EVENT_SINK: http://event-player:8080/events/pub
      CLOUD_EVENT_SOURCE: https://lab-resource-manager.io
      CLOUD_EVENT_TYPE_PREFIX: io.lab-resource-manager
      # Authentication
      KEYCLOAK_SERVER_URL: http://keycloak:8080
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-pyneuro}
      KEYCLOAK_CLIENT_ID: lab-manager-app
      # Application settings
      ENABLE_CORS: "true"
      # OpenTelemetry configuration - Metrics & Traces only (no logging)
      OTEL_SERVICE_NAME: lab-resource-manager
      OTEL_SERVICE_VERSION: 1.0.0
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_EXPORTER_OTLP_PROTOCOL: grpc
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      # Performance optimizations - DISABLED resource-heavy features:
      # OTEL_LOGS_EXPORTER: none (no log export)
      # OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: false (no auto-logging)
      # OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_*: not set (no header capture)
    volumes:
      - ../../:/app # Project root
      - ../../data/:/app/data
      # Mount Docker socket for container management (if needed)
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - pyneuro-net
    depends_on:
      - mongodb
      - keycloak
      - event-player
      - otel-collector

networks:
  pyneuro-net:
    external: true
    name: pyneuro-net
