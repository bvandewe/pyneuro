
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../event-driven/" rel="prev"/>
<link href="../reactive-programming/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.20" name="generator"/>
<title>Event Sourcing - Neuroglia Python Framework</title>
<link href="../../assets/stylesheets/main.e53b48f4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="blue" data-md-color-primary="blue" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#event-sourcing-pattern">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Neuroglia Python Framework" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Neuroglia Python Framework">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Neuroglia Python Framework
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Event Sourcing
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="blue" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg>
</a>
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../getting-started/">
          
  
  
  Getting Started

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../mario-pizzeria/">
          
  
  
  Mario's Pizzeria

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../">
          
  
  
  Patterns

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../features/">
          
  
  
  Features

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../guides/">
          
  
  
  Guides

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../samples/">
          
  
  
  Samples

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../examples/jsonserializer-configuration/">
          
  
  
  Examples

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../references/oauth-oidc-jwt/">
          
  
  
  References

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Neuroglia Python Framework" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Neuroglia Python Framework">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    Neuroglia Python Framework
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Getting Started
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../guides/3-min-bootstrap/">
<span class="md-ellipsis">
    3-Minute Bootstrap
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../guides/local-development/">
<span class="md-ellipsis">
    Local Development Setup
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../guides/mario-pizzeria-tutorial/">
<span class="md-ellipsis">
    Mario's Pizzeria Tutorial
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Mario's Pizzeria
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Mario's Pizzeria
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../mario-pizzeria/">
<span class="md-ellipsis">
    Case Study Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mario-pizzeria/business-analysis/">
<span class="md-ellipsis">
    Business Analysis
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mario-pizzeria/technical-architecture/">
<span class="md-ellipsis">
    Technical Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mario-pizzeria/domain-design/">
<span class="md-ellipsis">
    Domain Design
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mario-pizzeria/implementation-guide/">
<span class="md-ellipsis">
    Implementation Guide
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mario-pizzeria/testing-deployment/">
<span class="md-ellipsis">
    Testing &amp; Deployment
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    Patterns
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Patterns
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../clean-architecture/">
<span class="md-ellipsis">
    Clean Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../domain-driven-design/">
<span class="md-ellipsis">
    Domain Driven Design
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../dependency-injection/">
<span class="md-ellipsis">
    Dependency Injection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cqrs/">
<span class="md-ellipsis">
    CQRS &amp; Mediation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../event-driven/">
<span class="md-ellipsis">
    Event-Driven
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Event Sourcing
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Event Sourcing
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-intent">
<span class="md-ellipsis">
      ğŸ¯ Pattern Intent
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-structure">
<span class="md-ellipsis">
      ğŸ—ï¸ Pattern Structure
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-implementation">
<span class="md-ellipsis">
      ğŸ• Pattern Implementation
    </span>
</a>
<nav aria-label="ğŸ• Pattern Implementation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#core-event-sourcing-components">
<span class="md-ellipsis">
      Core Event Sourcing Components
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#event-store-configuration">
<span class="md-ellipsis">
      Event Store Configuration
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#event-driven-projections-pattern">
<span class="md-ellipsis">
      Event-Driven Projections Pattern
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#temporal-queries-pattern">
<span class="md-ellipsis">
      Temporal Queries Pattern
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#business-intelligence-pattern">
<span class="md-ellipsis">
      Business Intelligence Pattern
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#testing-patterns">
<span class="md-ellipsis">
      ğŸ§ª Testing Patterns
    </span>
</a>
<nav aria-label="ğŸ§ª Testing Patterns" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#aggregate-testing-pattern">
<span class="md-ellipsis">
      Aggregate Testing Pattern
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#framework-integration">
<span class="md-ellipsis">
      ğŸš€ Framework Integration
    </span>
</a>
<nav aria-label="ğŸš€ Framework Integration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#service-registration-pattern">
<span class="md-ellipsis">
      Service Registration Pattern
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-benefits">
<span class="md-ellipsis">
      ğŸ¯ Pattern Benefits
    </span>
</a>
<nav aria-label="ğŸ¯ Pattern Benefits" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#advantages">
<span class="md-ellipsis">
      Advantages
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#when-to-use">
<span class="md-ellipsis">
      When to Use
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#when-not-to-use">
<span class="md-ellipsis">
      When Not to Use
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#related-patterns">
<span class="md-ellipsis">
      ğŸ”— Related Patterns
    </span>
</a>
<nav aria-label="ğŸ”— Related Patterns" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#complementary-patterns">
<span class="md-ellipsis">
      Complementary Patterns
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#integration-examples">
<span class="md-ellipsis">
      Integration Examples
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../reactive-programming/">
<span class="md-ellipsis">
    Reactive Programming
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../repository/">
<span class="md-ellipsis">
    Repository
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../resource-oriented-architecture/">
<span class="md-ellipsis">
    Resource-Oriented Architecture
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../watcher-reconciliation-patterns/">
<span class="md-ellipsis">
    Watcher &amp; Reconciliation Patterns
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../watcher-reconciliation-execution/">
<span class="md-ellipsis">
    Watcher &amp; Reconciliation Execution
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Features
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Features
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/mvc-controllers/">
<span class="md-ellipsis">
    MVC Controllers
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/data-access/">
<span class="md-ellipsis">
    Data Access
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/serialization/">
<span class="md-ellipsis">
    Serialization
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/configurable-type-discovery/">
<span class="md-ellipsis">
    Configurable Type Discovery
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/object-mapping/">
<span class="md-ellipsis">
    Object Mapping
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/background-task-scheduling/">
<span class="md-ellipsis">
    Background Task Scheduling
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/redis-cache-repository/">
<span class="md-ellipsis">
    Redis Cache Repository
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/http-service-client/">
<span class="md-ellipsis">
    HTTP Service Client
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/case-conversion-utilities/">
<span class="md-ellipsis">
    Case Conversion Utilities
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/enhanced-model-validation/">
<span class="md-ellipsis">
    Enhanced Model Validation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../features/mermaid-diagrams/">
<span class="md-ellipsis">
    Mermaid Diagrams
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    Guides
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Guides
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../guides/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../guides/project-setup/">
<span class="md-ellipsis">
    Project Setup
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../guides/testing-setup/">
<span class="md-ellipsis">
    Testing Setup
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-ellipsis">
    Samples
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            Samples
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../samples/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../samples/openbank/">
<span class="md-ellipsis">
    OpenBank
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../samples/api_gateway/">
<span class="md-ellipsis">
    API Gateway
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../samples/desktop_controller/">
<span class="md-ellipsis">
    Desktop Controller
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_8" type="checkbox"/>
<label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
<span class="md-ellipsis">
    Examples
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
            Examples
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../examples/jsonserializer-configuration/">
<span class="md-ellipsis">
    JsonSerializer Configuration
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_9" type="checkbox"/>
<label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
<span class="md-ellipsis">
    References
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_9_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_9">
<span class="md-nav__icon md-icon"></span>
            References
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../references/oauth-oidc-jwt/">
<span class="md-ellipsis">
    OAuth, OIDC &amp; JWT
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../references/source_code_naming_convention/">
<span class="md-ellipsis">
    Source Code Naming Conventions
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../references/12-factor-app/">
<span class="md-ellipsis">
    12-Factor App
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../references/python_type_hints/">
<span class="md-ellipsis">
    Python Type Hints
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../references/python_modular_code/">
<span class="md-ellipsis">
    Python Modular Code
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../references/python_object_oriented/">
<span class="md-ellipsis">
    Python Object-Oriented Programming
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../references/python_generic_types/">
<span class="md-ellipsis">
    Python Generic Types
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-intent">
<span class="md-ellipsis">
      ğŸ¯ Pattern Intent
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-structure">
<span class="md-ellipsis">
      ğŸ—ï¸ Pattern Structure
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-implementation">
<span class="md-ellipsis">
      ğŸ• Pattern Implementation
    </span>
</a>
<nav aria-label="ğŸ• Pattern Implementation" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#core-event-sourcing-components">
<span class="md-ellipsis">
      Core Event Sourcing Components
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#event-store-configuration">
<span class="md-ellipsis">
      Event Store Configuration
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#event-driven-projections-pattern">
<span class="md-ellipsis">
      Event-Driven Projections Pattern
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#temporal-queries-pattern">
<span class="md-ellipsis">
      Temporal Queries Pattern
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#business-intelligence-pattern">
<span class="md-ellipsis">
      Business Intelligence Pattern
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#testing-patterns">
<span class="md-ellipsis">
      ğŸ§ª Testing Patterns
    </span>
</a>
<nav aria-label="ğŸ§ª Testing Patterns" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#aggregate-testing-pattern">
<span class="md-ellipsis">
      Aggregate Testing Pattern
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#framework-integration">
<span class="md-ellipsis">
      ğŸš€ Framework Integration
    </span>
</a>
<nav aria-label="ğŸš€ Framework Integration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#service-registration-pattern">
<span class="md-ellipsis">
      Service Registration Pattern
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#pattern-benefits">
<span class="md-ellipsis">
      ğŸ¯ Pattern Benefits
    </span>
</a>
<nav aria-label="ğŸ¯ Pattern Benefits" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#advantages">
<span class="md-ellipsis">
      Advantages
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#when-to-use">
<span class="md-ellipsis">
      When to Use
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#when-not-to-use">
<span class="md-ellipsis">
      When Not to Use
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#related-patterns">
<span class="md-ellipsis">
      ğŸ”— Related Patterns
    </span>
</a>
<nav aria-label="ğŸ”— Related Patterns" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#complementary-patterns">
<span class="md-ellipsis">
      Complementary Patterns
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#integration-examples">
<span class="md-ellipsis">
      Integration Examples
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="event-sourcing-pattern">ğŸ¯ Event Sourcing Pattern<a class="headerlink" href="#event-sourcing-pattern" title="Permanent link">Â¶</a></h1>
<p>Event Sourcing is a data storage pattern where state changes are stored as a sequence of immutable events rather
than updating data in place. Instead of persisting current state directly, the pattern captures all changes as
events that can be replayed to reconstruct state at any point in time, providing complete audit trails, temporal
queries, and business intelligence capabilities.</p>
<h2 id="pattern-intent">ğŸ¯ Pattern Intent<a class="headerlink" href="#pattern-intent" title="Permanent link">Â¶</a></h2>
<p>Replace traditional state-based persistence with an append-only event log that serves as the authoritative source
of
truth. Enable system reconstruction, audit trails, temporal queries, and business analytics through immutable event
sequences while maintaining data integrity and providing deep insights into system behavior over time.</p>
<h2 id="pattern-structure">ğŸ—ï¸ Pattern Structure<a class="headerlink" href="#pattern-structure" title="Permanent link">Â¶</a></h2>
<pre class="mermaid"><code>flowchart TD
    subgraph "ğŸ¯ Event Sourcing Core"
        A["ğŸ“ Domain Events&lt;br/&gt;Immutable Facts"]
        B["ğŸ“š Event Store&lt;br/&gt;Append-Only Log"]
        C["ğŸ”„ Event Stream&lt;br/&gt;Ordered Sequence"]
        D["ğŸ—ï¸ Aggregate Root&lt;br/&gt;Business Logic"]
    end

    subgraph "ğŸ“Š State Management"
        E["âš¡ Current State&lt;br/&gt;Computed from Events"]
        F["ğŸ•°ï¸ Historical State&lt;br/&gt;Point-in-Time Queries"]
        G["ğŸ“ˆ Event Replay&lt;br/&gt;State Reconstruction"]
        H["ğŸ“¸ Snapshots&lt;br/&gt;Performance Optimization"]
    end

    subgraph "ğŸ“‹ Read Models"
        I["ğŸ“Š Projections&lt;br/&gt;Optimized Views"]
        J["ğŸ” Query Models&lt;br/&gt;Specialized Indexes"]
        K["ğŸ“ˆ Analytics Views&lt;br/&gt;Business Intelligence"]
        L["ğŸ¯ Denormalized Data&lt;br/&gt;Fast Queries"]
    end

    A --&gt; B
    B --&gt; C
    C --&gt; D
    D --&gt; E

    C --&gt; F
    B --&gt; G
    E --&gt; H

    C --&gt; I
    I --&gt; J
    I --&gt; K
    I --&gt; L

    style B fill:#e1f5fe,stroke:#0277bd,stroke-width:3px
    style C fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style E fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px

    classDef projections fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    class I,J,K,L projections

    classDef state fill:#fce4ec,stroke:#ad1457,stroke-width:2px
    class E,F,G,H state</code></pre>
<h2 id="pattern-implementation">ğŸ• Pattern Implementation<a class="headerlink" href="#pattern-implementation" title="Permanent link">Â¶</a></h2>
<h3 id="core-event-sourcing-components">Core Event Sourcing Components<a class="headerlink" href="#core-event-sourcing-components" title="Permanent link">Â¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">neuroglia.data.abstractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">AggregateRoot</span><span class="p">,</span> <span class="n">DomainEvent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neuroglia.eventing</span><span class="w"> </span><span class="kn">import</span> <span class="n">event_handler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multipledispatch</span><span class="w"> </span><span class="kn">import</span> <span class="n">dispatch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="c1"># Domain Events - Immutable Facts</span>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PizzaOrderPlacedEvent</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Event representing a pizza order being placed"""</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="n">total_amount</span><span class="p">:</span> <span class="n">Decimal</span>
    <span class="n">placed_at</span><span class="p">:</span> <span class="n">datetime</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PizzaOrderConfirmedEvent</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Event representing order confirmation"""</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">estimated_delivery_time</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">kitchen_notes</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">confirmed_at</span><span class="p">:</span> <span class="n">datetime</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PaymentProcessedEvent</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Event representing successful payment"""</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">payment_method</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">amount</span><span class="p">:</span> <span class="n">Decimal</span>
    <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">processed_at</span><span class="p">:</span> <span class="n">datetime</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderStatusChangedEvent</span><span class="p">(</span><span class="n">DomainEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Event representing order status changes"""</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">previous_status</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">new_status</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">changed_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Aggregate Root with Event Sourcing</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PizzaOrder</span><span class="p">(</span><span class="n">AggregateRoot</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">"""Pizza order aggregate using event sourcing"""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">order_id</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>

        <span class="c1"># Current state computed from events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_amount</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">'0.00'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s2">"PENDING"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_placed_at</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_estimated_delivery</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_payment_status</span> <span class="o">=</span> <span class="s2">"UNPAID"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kitchen_notes</span> <span class="o">=</span> <span class="s2">""</span>

    <span class="c1"># Business Logic Methods - Produce Events</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">place_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">total_amount</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Place a new pizza order - produces PizzaOrderPlacedEvent"""</span>

        <span class="c1"># Business rule validation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Order must contain at least one item"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Order total must be positive"</span><span class="p">)</span>

        <span class="c1"># Create and register domain event</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">PizzaOrderPlacedEvent</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>
            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span>
            <span class="n">total_amount</span><span class="o">=</span><span class="n">total_amount</span><span class="p">,</span>
            <span class="n">placed_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Apply event to update state and register for persistence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register_event</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">confirm_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimated_delivery_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">kitchen_notes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Confirm order - produces PizzaOrderConfirmedEvent"""</span>

        <span class="c1"># Business rule validation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">!=</span> <span class="s2">"PENDING"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cannot confirm order in status: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">PizzaOrderConfirmedEvent</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>
            <span class="n">estimated_delivery_time</span><span class="o">=</span><span class="n">estimated_delivery_time</span><span class="p">,</span>
            <span class="n">kitchen_notes</span><span class="o">=</span><span class="n">kitchen_notes</span><span class="p">,</span>
            <span class="n">confirmed_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register_event</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payment_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Process payment - produces PaymentProcessedEvent"""</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_payment_status</span> <span class="o">==</span> <span class="s2">"PAID"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Order is already paid"</span><span class="p">)</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">PaymentProcessedEvent</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>
            <span class="n">payment_method</span><span class="o">=</span><span class="n">payment_method</span><span class="p">,</span>
            <span class="n">amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_amount</span><span class="p">,</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="n">transaction_id</span><span class="p">,</span>
            <span class="n">processed_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register_event</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">change_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Change order status - produces OrderStatusChangedEvent"""</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="n">new_status</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># No change needed</span>

        <span class="n">event</span> <span class="o">=</span> <span class="n">OrderStatusChangedEvent</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>
            <span class="n">previous_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">,</span>
            <span class="n">new_status</span><span class="o">=</span><span class="n">new_status</span><span class="p">,</span>
            <span class="n">changed_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
            <span class="n">reason</span><span class="o">=</span><span class="n">reason</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">register_event</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

    <span class="c1"># State Reconstruction from Events using @dispatch</span>
    <span class="nd">@dispatch</span><span class="p">(</span><span class="n">PizzaOrderPlacedEvent</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">state_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">PizzaOrderPlacedEvent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Apply order placed event to reconstruct state"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_items</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_amount</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">total_amount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s2">"PENDING"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_placed_at</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">placed_at</span>

    <span class="nd">@dispatch</span><span class="p">(</span><span class="n">PizzaOrderConfirmedEvent</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">state_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">PizzaOrderConfirmedEvent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Apply order confirmed event to reconstruct state"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s2">"CONFIRMED"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_estimated_delivery</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">estimated_delivery_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kitchen_notes</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">kitchen_notes</span>

    <span class="nd">@dispatch</span><span class="p">(</span><span class="n">PaymentProcessedEvent</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">state_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">PaymentProcessedEvent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Apply payment processed event to reconstruct state"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_payment_status</span> <span class="o">=</span> <span class="s2">"PAID"</span>
        <span class="c1"># Automatically move to cooking if order is confirmed and paid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">==</span> <span class="s2">"CONFIRMED"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s2">"COOKING"</span>

    <span class="nd">@dispatch</span><span class="p">(</span><span class="n">OrderStatusChangedEvent</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">state_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderStatusChangedEvent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Apply status change event to reconstruct state"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">new_status</span>

    <span class="c1"># Property Accessors for Current State</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">customer_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_customer_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_items</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_amount</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_amount</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">payment_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_payment_status</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">placed_at</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_placed_at</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">estimated_delivery</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimated_delivery</span>
</code></pre></div>
<h3 id="event-store-configuration">Event Store Configuration<a class="headerlink" href="#event-store-configuration" title="Permanent link">Â¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">neuroglia.data.infrastructure.event_sourcing.event_store</span><span class="w"> </span><span class="kn">import</span> <span class="n">ESEventStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neuroglia.data.infrastructure.event_sourcing.abstractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventStoreOptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neuroglia.hosting.web</span><span class="w"> </span><span class="kn">import</span> <span class="n">WebApplicationBuilder</span>

<span class="k">def</span><span class="w"> </span><span class="nf">configure_event_store</span><span class="p">(</span><span class="n">builder</span><span class="p">:</span> <span class="n">WebApplicationBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Configure EventStoreDB for event sourcing"""</span>

    <span class="c1"># Event store configuration</span>
    <span class="n">database_name</span> <span class="o">=</span> <span class="s2">"mario_pizzeria"</span>
    <span class="n">consumer_group</span> <span class="o">=</span> <span class="s2">"pizzeria-api-v1"</span>

    <span class="n">ESEventStore</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span>
        <span class="n">builder</span><span class="p">,</span>
        <span class="n">EventStoreOptions</span><span class="p">(</span>
            <span class="n">database_name</span><span class="o">=</span><span class="n">database_name</span><span class="p">,</span>
            <span class="n">consumer_group</span><span class="o">=</span><span class="n">consumer_group</span><span class="p">,</span>
            <span class="n">connection_string</span><span class="o">=</span><span class="s2">"esdb://localhost:2113?tls=false"</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="p">{</span><span class="s2">"username"</span><span class="p">:</span> <span class="s2">"admin"</span><span class="p">,</span> <span class="s2">"password"</span><span class="p">:</span> <span class="s2">"changeit"</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Configure event sourcing repository for write model</span>
    <span class="n">EventSourcingRepository</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">PizzaOrder</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">builder</span>

<span class="c1"># Repository Pattern for Event-Sourced Aggregates</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EventSourcingRepository</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Repository for event-sourced aggregates"""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_store</span><span class="p">:</span> <span class="n">EventStore</span><span class="p">,</span> <span class="n">aggregator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="o">=</span> <span class="n">aggregator</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">:</span> <span class="n">PizzaOrder</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PizzaOrder</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Save aggregate events to event store"""</span>

        <span class="c1"># Get uncommitted events from aggregate</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">get_uncommitted_events</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">aggregate</span>

        <span class="c1"># Persist events to event store</span>
        <span class="n">stream_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"PizzaOrder-</span><span class="si">{</span><span class="n">aggregate</span><span class="o">.</span><span class="n">id</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">append_async</span><span class="p">(</span>
            <span class="n">stream_id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">,</span>
            <span class="n">events</span><span class="o">=</span><span class="n">events</span><span class="p">,</span>
            <span class="n">expected_version</span><span class="o">=</span><span class="n">aggregate</span><span class="o">.</span><span class="n">version</span>
        <span class="p">)</span>

        <span class="c1"># Mark events as committed</span>
        <span class="n">aggregate</span><span class="o">.</span><span class="n">mark_events_as_committed</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">aggregate</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PizzaOrder</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Load aggregate by ID from event store"""</span>

        <span class="n">stream_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"PizzaOrder-</span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">"</span>

        <span class="c1"># Read events from event store</span>
        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">read_async</span><span class="p">(</span>
            <span class="n">stream_id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">StreamReadDirection</span><span class="o">.</span><span class="n">FORWARDS</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Reconstruct aggregate from events</span>
        <span class="n">aggregate</span> <span class="o">=</span> <span class="n">PizzaOrder</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">event_record</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">aggregate</span><span class="o">.</span><span class="n">state_manager</span><span class="p">(</span><span class="n">event_record</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">aggregate</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">event_record</span><span class="o">.</span><span class="n">stream_revision</span>

        <span class="k">return</span> <span class="n">aggregate</span>
</code></pre></div>
<h3 id="event-driven-projections-pattern">Event-Driven Projections Pattern<a class="headerlink" href="#event-driven-projections-pattern" title="Permanent link">Â¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">neuroglia.eventing</span><span class="w"> </span><span class="kn">import</span> <span class="n">event_handler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neuroglia.data.abstractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Repository</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PizzaOrderProjection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Optimized read model for pizza order queries"""</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">customer_name</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Denormalized for fast queries</span>
    <span class="n">customer_email</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Denormalized for fast queries</span>
    <span class="n">item_count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">total_amount</span><span class="p">:</span> <span class="n">Decimal</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">payment_status</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">placed_at</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">estimated_delivery</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span>
    <span class="n">last_updated</span><span class="p">:</span> <span class="n">datetime</span>

    <span class="c1"># Analytics fields computed from events</span>
    <span class="n">time_to_confirmation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># seconds</span>
    <span class="n">time_to_payment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># seconds</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PizzaOrderProjectionHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Handles domain events to update read model projections"""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_repository</span><span class="p">:</span> <span class="n">Repository</span><span class="p">[</span><span class="n">PizzaOrderProjection</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_repository</span> <span class="o">=</span> <span class="n">read_repository</span>

    <span class="nd">@event_handler</span><span class="p">(</span><span class="n">PizzaOrderPlacedEvent</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">PizzaOrderPlacedEvent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Create read model projection when order is placed"""</span>

        <span class="c1"># Fetch customer details for denormalization</span>
        <span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_customer_details</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>

        <span class="n">projection</span> <span class="o">=</span> <span class="n">PizzaOrderProjection</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="n">customer_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
            <span class="n">customer_name</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">customer</span> <span class="k">else</span> <span class="s2">"Unknown"</span><span class="p">,</span>
            <span class="n">customer_email</span><span class="o">=</span><span class="n">customer</span><span class="o">.</span><span class="n">email</span> <span class="k">if</span> <span class="n">customer</span> <span class="k">else</span> <span class="s2">""</span><span class="p">,</span>
            <span class="n">item_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">items</span><span class="p">),</span>
            <span class="n">total_amount</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">total_amount</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">"PENDING"</span><span class="p">,</span>
            <span class="n">payment_status</span><span class="o">=</span><span class="s2">"UNPAID"</span><span class="p">,</span>
            <span class="n">placed_at</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">placed_at</span><span class="p">,</span>
            <span class="n">estimated_delivery</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">last_updated</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">placed_at</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_repository</span><span class="o">.</span><span class="n">add_async</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="nd">@event_handler</span><span class="p">(</span><span class="n">PizzaOrderConfirmedEvent</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_order_confirmed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">PizzaOrderConfirmedEvent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Update projection when order is confirmed"""</span>

        <span class="n">projection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_repository</span><span class="o">.</span><span class="n">get_by_id_async</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
            <span class="c1"># Calculate time to confirmation</span>
            <span class="n">time_to_confirmation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">event</span><span class="o">.</span><span class="n">confirmed_at</span> <span class="o">-</span> <span class="n">projection</span><span class="o">.</span><span class="n">placed_at</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

            <span class="n">projection</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">"CONFIRMED"</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">estimated_delivery</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">estimated_delivery_time</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">time_to_confirmation</span> <span class="o">=</span> <span class="n">time_to_confirmation</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">confirmed_at</span>

            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_repository</span><span class="o">.</span><span class="n">update_async</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="nd">@event_handler</span><span class="p">(</span><span class="n">PaymentProcessedEvent</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_payment_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">PaymentProcessedEvent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Update projection when payment is processed"""</span>

        <span class="n">projection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_repository</span><span class="o">.</span><span class="n">get_by_id_async</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
            <span class="c1"># Calculate time to payment</span>
            <span class="n">time_to_payment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">event</span><span class="o">.</span><span class="n">processed_at</span> <span class="o">-</span> <span class="n">projection</span><span class="o">.</span><span class="n">placed_at</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>

            <span class="n">projection</span><span class="o">.</span><span class="n">payment_status</span> <span class="o">=</span> <span class="s2">"PAID"</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">time_to_payment</span> <span class="o">=</span> <span class="n">time_to_payment</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">processed_at</span>

            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_repository</span><span class="o">.</span><span class="n">update_async</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="nd">@event_handler</span><span class="p">(</span><span class="n">OrderStatusChangedEvent</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_status_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderStatusChangedEvent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Update projection when order status changes"""</span>

        <span class="n">projection</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_repository</span><span class="o">.</span><span class="n">get_by_id_async</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">new_status</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">last_updated</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">changed_at</span>

            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_repository</span><span class="o">.</span><span class="n">update_async</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_customer_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Fetch customer details for denormalization"""</span>
        <span class="c1"># Implementation would fetch from customer service/repository</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<h3 id="temporal-queries-pattern">Temporal Queries Pattern<a class="headerlink" href="#temporal-queries-pattern" title="Permanent link">Â¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TemporalQueryService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Service for temporal queries on event-sourced aggregates"""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_store</span><span class="p">:</span> <span class="n">EventStore</span><span class="p">,</span> <span class="n">aggregator</span><span class="p">:</span> <span class="n">Aggregator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator</span> <span class="o">=</span> <span class="n">aggregator</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_order_status_at_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Get order status as it was at a specific point in time"""</span>

        <span class="n">stream_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"PizzaOrder-</span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">"</span>

        <span class="c1"># Read events up to the specified time</span>
        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">read_async</span><span class="p">(</span>
            <span class="n">stream_id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">StreamReadDirection</span><span class="o">.</span><span class="n">FORWARDS</span><span class="p">,</span>
            <span class="n">from_position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">to_time</span><span class="o">=</span><span class="n">as_of_time</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Reconstruct state at that point in time</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">PizzaOrder</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">event_record</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">order</span><span class="o">.</span><span class="n">state_manager</span><span class="p">(</span><span class="n">event_record</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_order_timeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Get complete timeline of order changes"""</span>

        <span class="n">stream_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"PizzaOrder-</span><span class="si">{</span><span class="n">order_id</span><span class="si">}</span><span class="s2">"</span>

        <span class="n">events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">read_async</span><span class="p">(</span>
            <span class="n">stream_id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">StreamReadDirection</span><span class="o">.</span><span class="n">FORWARDS</span>
        <span class="p">)</span>

        <span class="n">timeline</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event_record</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">event_data</span> <span class="o">=</span> <span class="n">event_record</span><span class="o">.</span><span class="n">data</span>

            <span class="n">timeline_entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'timestamp'</span><span class="p">:</span> <span class="n">event_record</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
                <span class="s1">'event_type'</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s1">'description'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_event_description</span><span class="p">(</span><span class="n">event_data</span><span class="p">),</span>
                <span class="s1">'details'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_event_details</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeline_entry</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">timeline</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_event_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">DomainEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate human-readable description for events"""</span>
        <span class="n">descriptions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'PizzaOrderPlacedEvent'</span><span class="p">:</span> <span class="s1">'Order placed by customer'</span><span class="p">,</span>
            <span class="s1">'PizzaOrderConfirmedEvent'</span><span class="p">:</span> <span class="s1">'Order confirmed by restaurant'</span><span class="p">,</span>
            <span class="s1">'PaymentProcessedEvent'</span><span class="p">:</span> <span class="s1">'Payment processed successfully'</span><span class="p">,</span>
            <span class="s1">'OrderStatusChangedEvent'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'Status changed to </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">new_status</span><span class="si">}</span><span class="s1">'</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">descriptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">'Event occurred'</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_event_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">DomainEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Extract relevant details from events for timeline"""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">PizzaOrderPlacedEvent</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">'customer_id'</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
                <span class="s1">'item_count'</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">items</span><span class="p">),</span>
                <span class="s1">'total_amount'</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">total_amount</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">PaymentProcessedEvent</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">'payment_method'</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">payment_method</span><span class="p">,</span>
                <span class="s1">'transaction_id'</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">,</span>
                <span class="s1">'amount'</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">OrderStatusChangedEvent</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">'previous_status'</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">previous_status</span><span class="p">,</span>
                <span class="s1">'new_status'</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">new_status</span><span class="p">,</span>
                <span class="s1">'reason'</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">reason</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="p">{}</span>
</code></pre></div>
<h3 id="business-intelligence-pattern">Business Intelligence Pattern<a class="headerlink" href="#business-intelligence-pattern" title="Permanent link">Â¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PizzeriaAnalyticsService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Service for analyzing business patterns from events"""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_store</span><span class="p">:</span> <span class="n">EventStore</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span> <span class="o">=</span> <span class="n">event_store</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_order_analytics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">to_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">"""Analyze order patterns over time"""</span>

        <span class="c1"># Query all order events in date range</span>
        <span class="n">placed_events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">get_events_by_type_async</span><span class="p">(</span>
            <span class="n">PizzaOrderPlacedEvent</span><span class="p">,</span>
            <span class="n">from_date</span><span class="o">=</span><span class="n">from_date</span><span class="p">,</span>
            <span class="n">to_date</span><span class="o">=</span><span class="n">to_date</span>
        <span class="p">)</span>

        <span class="n">confirmed_events</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_store</span><span class="o">.</span><span class="n">get_events_by_type_async</span><span class="p">(</span>
            <span class="n">PizzaOrderConfirmedEvent</span><span class="p">,</span>
            <span class="n">from_date</span><span class="o">=</span><span class="n">from_date</span><span class="p">,</span>
            <span class="n">to_date</span><span class="o">=</span><span class="n">to_date</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">placed_events</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">"message"</span><span class="p">:</span> <span class="s2">"No orders found in date range"</span><span class="p">}</span>

        <span class="c1"># Calculate analytics</span>
        <span class="n">total_orders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">placed_events</span><span class="p">)</span>
        <span class="n">total_revenue</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">total_amount</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">placed_events</span><span class="p">)</span>
        <span class="n">confirmed_orders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">confirmed_events</span><span class="p">)</span>
        <span class="n">confirmation_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">confirmed_orders</span> <span class="o">/</span> <span class="n">total_orders</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total_orders</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Analyze order sizes and items</span>
        <span class="n">all_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">placed_events</span><span class="p">:</span>
            <span class="n">all_items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>

        <span class="n">average_order_value</span> <span class="o">=</span> <span class="n">total_revenue</span> <span class="o">/</span> <span class="n">total_orders</span> <span class="k">if</span> <span class="n">total_orders</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">"period"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"from"</span><span class="p">:</span> <span class="n">from_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="s2">"to"</span><span class="p">:</span> <span class="n">to_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()},</span>
            <span class="s2">"total_orders"</span><span class="p">:</span> <span class="n">total_orders</span><span class="p">,</span>
            <span class="s2">"confirmed_orders"</span><span class="p">:</span> <span class="n">confirmed_orders</span><span class="p">,</span>
            <span class="s2">"confirmation_rate"</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">confirmation_rate</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">"total_revenue"</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_revenue</span><span class="p">),</span>
            <span class="s2">"average_order_value"</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">average_order_value</span><span class="p">),</span>
            <span class="s2">"total_items_sold"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_items</span><span class="p">),</span>
            <span class="s2">"popular_items"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_popular_items</span><span class="p">(</span><span class="n">all_items</span><span class="p">),</span>
            <span class="s2">"daily_breakdown"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_daily_breakdown</span><span class="p">(</span><span class="n">placed_events</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_analyze_popular_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Analyze most popular items"""</span>
        <span class="n">item_counts</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">item_name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'Unknown'</span><span class="p">)</span>
            <span class="n">item_counts</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'quantity'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Sort by popularity</span>
        <span class="n">popular_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">"item_name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">"total_sold"</span><span class="p">:</span> <span class="n">count</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">popular_items</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>  <span class="c1"># Top 10</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_daily_breakdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PizzaOrderPlacedEvent</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">"""Calculate daily order breakdown"""</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">day_key</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">placed_at</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">day_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">daily_data</span><span class="p">:</span>
                <span class="n">daily_data</span><span class="p">[</span><span class="n">day_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"count"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"revenue"</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">'0.00'</span><span class="p">)}</span>

            <span class="n">daily_data</span><span class="p">[</span><span class="n">day_key</span><span class="p">][</span><span class="s2">"count"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">daily_data</span><span class="p">[</span><span class="n">day_key</span><span class="p">][</span><span class="s2">"revenue"</span><span class="p">]</span> <span class="o">+=</span> <span class="n">event</span><span class="o">.</span><span class="n">total_amount</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">"date"</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
                <span class="s2">"order_count"</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s2">"count"</span><span class="p">],</span>
                <span class="s2">"daily_revenue"</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">"revenue"</span><span class="p">])</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">date</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">]</span>
</code></pre></div>
<h2 id="testing-patterns">ğŸ§ª Testing Patterns<a class="headerlink" href="#testing-patterns" title="Permanent link">Â¶</a></h2>
<h3 id="aggregate-testing-pattern">Aggregate Testing Pattern<a class="headerlink" href="#aggregate-testing-pattern" title="Permanent link">Â¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestPizzaOrderAggregate</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Unit tests for PizzaOrder aggregate using event sourcing"""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_place_order_raises_correct_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Test that placing an order raises the correct event"""</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">PizzaOrder</span><span class="p">()</span>
        <span class="n">customer_id</span> <span class="o">=</span> <span class="s2">"customer-123"</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Margherita"</span><span class="p">,</span> <span class="s2">"quantity"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">:</span> <span class="mf">12.50</span><span class="p">}]</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"25.00"</span><span class="p">)</span>

        <span class="n">order</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>

        <span class="n">events</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">get_uncommitted_events</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PizzaOrderPlacedEvent</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">customer_id</span>
        <span class="k">assert</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">total_amount</span> <span class="o">==</span> <span class="n">total</span>
        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">"PENDING"</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_confirm_order_updates_status_and_raises_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Test order confirmation produces correct event and state"""</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_placed_order</span><span class="p">()</span>

        <span class="n">estimated_delivery</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">kitchen_notes</span> <span class="o">=</span> <span class="s2">"Extra cheese"</span>

        <span class="n">order</span><span class="o">.</span><span class="n">confirm_order</span><span class="p">(</span><span class="n">estimated_delivery</span><span class="p">,</span> <span class="n">kitchen_notes</span><span class="p">)</span>

        <span class="c1"># Check event was raised</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">get_uncommitted_events</span><span class="p">()</span>
        <span class="n">confirm_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">PizzaOrderConfirmedEvent</span><span class="p">)]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">confirm_events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">confirm_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">estimated_delivery_time</span> <span class="o">==</span> <span class="n">estimated_delivery</span>
        <span class="k">assert</span> <span class="n">confirm_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">kitchen_notes</span> <span class="o">==</span> <span class="n">kitchen_notes</span>

        <span class="c1"># Check state was updated</span>
        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">"CONFIRMED"</span>
        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">estimated_delivery</span> <span class="o">==</span> <span class="n">estimated_delivery</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_payment_processing_updates_payment_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Test payment processing updates status correctly"""</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_confirmed_order</span><span class="p">()</span>

        <span class="n">payment_method</span> <span class="o">=</span> <span class="s2">"credit_card"</span>
        <span class="n">transaction_id</span> <span class="o">=</span> <span class="s2">"txn-123456"</span>

        <span class="n">order</span><span class="o">.</span><span class="n">process_payment</span><span class="p">(</span><span class="n">payment_method</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">)</span>

        <span class="c1"># Check event was raised</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">get_uncommitted_events</span><span class="p">()</span>
        <span class="n">payment_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">PaymentProcessedEvent</span><span class="p">)]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">payment_events</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">payment_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">payment_method</span> <span class="o">==</span> <span class="n">payment_method</span>
        <span class="k">assert</span> <span class="n">payment_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transaction_id</span> <span class="o">==</span> <span class="n">transaction_id</span>

        <span class="c1"># Check state updates</span>
        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">payment_status</span> <span class="o">==</span> <span class="s2">"PAID"</span>
        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">"COOKING"</span>  <span class="c1"># Auto-transition to cooking</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_state_reconstruction_from_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Test that aggregate state can be reconstructed from events"""</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">PizzaOrder</span><span class="p">(</span><span class="s2">"test-order-123"</span><span class="p">)</span>

        <span class="c1"># Create events to simulate event store loading</span>
        <span class="n">placed_event</span> <span class="o">=</span> <span class="n">PizzaOrderPlacedEvent</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="s2">"test-order-123"</span><span class="p">,</span>
            <span class="n">customer_id</span><span class="o">=</span><span class="s2">"customer-456"</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="p">[{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Pepperoni"</span><span class="p">,</span> <span class="s2">"quantity"</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span>
            <span class="n">total_amount</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">"15.00"</span><span class="p">),</span>
            <span class="n">placed_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">confirmed_event</span> <span class="o">=</span> <span class="n">PizzaOrderConfirmedEvent</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="s2">"test-order-123"</span><span class="p">,</span>
            <span class="n">estimated_delivery_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">25</span><span class="p">),</span>
            <span class="n">kitchen_notes</span><span class="o">=</span><span class="s2">"No onions"</span><span class="p">,</span>
            <span class="n">confirmed_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Apply events to reconstruct state</span>
        <span class="n">order</span><span class="o">.</span><span class="n">state_manager</span><span class="p">(</span><span class="n">placed_event</span><span class="p">)</span>
        <span class="n">order</span><span class="o">.</span><span class="n">state_manager</span><span class="p">(</span><span class="n">confirmed_event</span><span class="p">)</span>

        <span class="c1"># Verify state reconstruction</span>
        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="s2">"customer-456"</span>
        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">total_amount</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"15.00"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">"CONFIRMED"</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_business_rule_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Test business rule validation prevents invalid operations"""</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">PizzaOrder</span><span class="p">()</span>

        <span class="c1"># Test empty items validation</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">"Order must contain at least one item"</span><span class="p">):</span>
            <span class="n">order</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="s2">"customer-123"</span><span class="p">,</span> <span class="p">[],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"0.00"</span><span class="p">))</span>

        <span class="c1"># Test negative total validation</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">"Order total must be positive"</span><span class="p">):</span>
            <span class="n">order</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="s2">"customer-123"</span><span class="p">,</span> <span class="p">[{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Pizza"</span><span class="p">}],</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"-10.00"</span><span class="p">))</span>

        <span class="c1"># Test confirmation of non-pending order</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_placed_order</span><span class="p">()</span>
        <span class="n">order</span><span class="o">.</span><span class="n">change_status</span><span class="p">(</span><span class="s2">"DELIVERED"</span><span class="p">)</span>  <span class="c1"># Change to delivered status</span>

        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="s2">"Cannot confirm order in status: DELIVERED"</span><span class="p">):</span>
            <span class="n">order</span><span class="o">.</span><span class="n">confirm_order</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span> <span class="s2">"test"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_placed_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PizzaOrder</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Helper to create a placed order"""</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">PizzaOrder</span><span class="p">()</span>
        <span class="n">order</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span>
            <span class="s2">"customer-123"</span><span class="p">,</span>
            <span class="p">[{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Margherita"</span><span class="p">,</span> <span class="s2">"quantity"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">:</span> <span class="mf">12.50</span><span class="p">}],</span>
            <span class="n">Decimal</span><span class="p">(</span><span class="s2">"12.50"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">order</span><span class="o">.</span><span class="n">mark_events_as_committed</span><span class="p">()</span>  <span class="c1"># Clear events for clean testing</span>
        <span class="k">return</span> <span class="n">order</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_confirmed_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PizzaOrder</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Helper to create a confirmed order"""</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_placed_order</span><span class="p">()</span>
        <span class="n">order</span><span class="o">.</span><span class="n">confirm_order</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span> <span class="s2">"Test order"</span><span class="p">)</span>
        <span class="n">order</span><span class="o">.</span><span class="n">mark_events_as_committed</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">order</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestEventSourcingIntegration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Integration tests for event sourcing workflow"""</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_complete_aggregate_lifecycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_store_repository</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Test complete aggregate lifecycle with event store persistence"""</span>

        <span class="c1"># Create and place order</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">PizzaOrder</span><span class="p">()</span>
        <span class="n">order</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span>
            <span class="s2">"customer-integration-test"</span><span class="p">,</span>
            <span class="p">[{</span><span class="s2">"name"</span><span class="p">:</span> <span class="s2">"Integration Pizza"</span><span class="p">,</span> <span class="s2">"quantity"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">:</span> <span class="mf">20.00</span><span class="p">}],</span>
            <span class="n">Decimal</span><span class="p">(</span><span class="s2">"20.00"</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Save to event store</span>
        <span class="n">saved_order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">event_store_repository</span><span class="o">.</span><span class="n">save_async</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">saved_order</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Load from event store</span>
        <span class="n">loaded_order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">event_store_repository</span><span class="o">.</span><span class="n">get_by_id_async</span><span class="p">(</span><span class="n">saved_order</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">loaded_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">loaded_order</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="s2">"customer-integration-test"</span>
        <span class="k">assert</span> <span class="n">loaded_order</span><span class="o">.</span><span class="n">total_amount</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">"20.00"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">loaded_order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">"PENDING"</span>

        <span class="c1"># Modify and save again</span>
        <span class="n">loaded_order</span><span class="o">.</span><span class="n">confirm_order</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">35</span><span class="p">),</span> <span class="s2">"Integration test"</span><span class="p">)</span>
        <span class="n">updated_order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">event_store_repository</span><span class="o">.</span><span class="n">save_async</span><span class="p">(</span><span class="n">loaded_order</span><span class="p">)</span>

        <span class="c1"># Verify persistence of changes</span>
        <span class="n">final_order</span> <span class="o">=</span> <span class="k">await</span> <span class="n">event_store_repository</span><span class="o">.</span><span class="n">get_by_id_async</span><span class="p">(</span><span class="n">updated_order</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
        <span class="k">assert</span> <span class="n">final_order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">"CONFIRMED"</span>
        <span class="k">assert</span> <span class="n">final_order</span><span class="o">.</span><span class="n">estimated_delivery</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>
<h2 id="framework-integration">ğŸš€ Framework Integration<a class="headerlink" href="#framework-integration" title="Permanent link">Â¶</a></h2>
<h3 id="service-registration-pattern">Service Registration Pattern<a class="headerlink" href="#service-registration-pattern" title="Permanent link">Â¶</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">neuroglia.hosting</span><span class="w"> </span><span class="kn">import</span> <span class="n">WebApplicationBuilder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neuroglia.data.infrastructure.event_sourcing</span><span class="w"> </span><span class="kn">import</span> <span class="n">EventSourcingRepository</span>

<span class="k">def</span><span class="w"> </span><span class="nf">configure_event_sourcing_services</span><span class="p">(</span><span class="n">builder</span><span class="p">:</span> <span class="n">WebApplicationBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Configure event sourcing services with dependency injection"""</span>

    <span class="c1"># Configure event store</span>
    <span class="n">configure_event_store</span><span class="p">(</span><span class="n">builder</span><span class="p">)</span>

    <span class="c1"># Register event-sourced aggregate repositories</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">EventSourcingRepository</span><span class="p">[</span><span class="n">PizzaOrder</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span>

    <span class="c1"># Register event handlers for projections</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">PizzaOrderProjectionHandler</span><span class="p">)</span>

    <span class="c1"># Register query services</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">TemporalQueryService</span><span class="p">)</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">PizzeriaAnalyticsService</span><span class="p">)</span>

    <span class="c1"># Register read model repositories for projections</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">Repository</span><span class="p">[</span><span class="n">PizzaOrderProjection</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span>

<span class="c1"># Application startup with event sourcing</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_event_sourced_application</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""Create application with event sourcing support"""</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">WebApplicationBuilder</span><span class="p">()</span>

    <span class="c1"># Configure event sourcing</span>
    <span class="n">configure_event_sourcing_services</span><span class="p">(</span><span class="n">builder</span><span class="p">)</span>

    <span class="c1"># Build application</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<h2 id="pattern-benefits">ğŸ¯ Pattern Benefits<a class="headerlink" href="#pattern-benefits" title="Permanent link">Â¶</a></h2>
<h3 id="advantages">Advantages<a class="headerlink" href="#advantages" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong>Complete Audit Trail</strong>: Every state change is captured as an immutable event</li>
<li><strong>Temporal Queries</strong>: Query system state at any point in time</li>
<li><strong>Business Intelligence</strong>: Rich analytics from event stream analysis</li>
<li><strong>Event Replay</strong>: Reconstruct state and debug issues through event replay</li>
<li><strong>Scalability</strong>: Events can be replayed to create specialized read models</li>
<li><strong>Integration</strong>: Events provide natural integration points between bounded contexts</li>
</ul>
<h3 id="when-to-use">When to Use<a class="headerlink" href="#when-to-use" title="Permanent link">Â¶</a></h3>
<ul>
<li>Systems requiring complete audit trails and compliance</li>
<li>Applications needing temporal queries and historical analysis</li>
<li>Business domains with complex state transitions</li>
<li>Systems requiring sophisticated business intelligence and reporting</li>
<li>Applications with high read/write ratio where specialized read models provide value</li>
<li>Domains where understanding "how we got here" is as important as current state</li>
</ul>
<h3 id="when-not-to-use">When Not to Use<a class="headerlink" href="#when-not-to-use" title="Permanent link">Â¶</a></h3>
<ul>
<li>Simple CRUD applications with minimal business logic</li>
<li>Systems with very high write volumes where event storage becomes a bottleneck</li>
<li>Applications where eventual consistency is not acceptable</li>
<li>Teams lacking experience with event-driven architecture and eventual consistency</li>
<li>Systems where the complexity of event sourcing outweighs the benefits</li>
</ul>
<h2 id="related-patterns">ğŸ”— Related Patterns<a class="headerlink" href="#related-patterns" title="Permanent link">Â¶</a></h2>
<h3 id="complementary-patterns">Complementary Patterns<a class="headerlink" href="#complementary-patterns" title="Permanent link">Â¶</a></h3>
<ul>
<li><strong><a href="cqrs-mediation.md">CQRS</a></strong> - Command/Query separation works naturally with event sourcing</li>
<li><strong><a href="../repository/">Repository</a></strong> - Event sourcing repositories for aggregate persistence</li>
<li><strong><a href="../domain-driven-design/">Domain-Driven Design</a></strong> - Aggregates and domain events are core DDD concepts</li>
<li><strong><a href="../reactive-programming/">Reactive Programming</a></strong> - Event streams integrate with reactive patterns</li>
<li><strong><a href="event-driven-architecture.md">Event-Driven Architecture</a></strong> - Events provide integration between services</li>
<li><strong><a href="../dependency-injection/">Dependency Injection</a></strong> - Service registration for event sourcing infrastructure</li>
</ul>
<h3 id="integration-examples">Integration Examples<a class="headerlink" href="#integration-examples" title="Permanent link">Â¶</a></h3>
<p>Event Sourcing works particularly well with CQRS, where commands modify event-sourced aggregates and queries read from optimized projections built from the same event streams.</p>
<hr/>
<p><strong>Next Steps</strong>: Explore <a href="cqrs-mediation.md">CQRS &amp; Mediation</a> for command/query separation with event sourcing or <a href="../repository/">Repository</a> for aggregate persistence patterns.</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/bvandewe/pyneuro" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
</body>
</html>